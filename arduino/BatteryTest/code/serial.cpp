#include <avr/io.h>
#include <avr/pgmspace.h>
#include <avr/interrupt.h>

PROGMEM prog_uint8_t Voltage[] = {   
6,127,//0,2.9296875V 
4,179,//1,2.9345703125V 
12,179,//2,2.939453125V 
4,243,//3,2.9443359375V 
12,243,//4,2.94921875V 
6,243,//5,2.9541015625V 
14,243,//6,2.958984375V 
36,243,//7,2.9638671875V 
0,141,//8,2.96875V 
38,243,//9,2.9736328125V 
0,205,//10,2.978515625V 
3,77,//11,2.9833984375V 
0,157,//12,2.98828125V 
1,129,//13,2.9931640625V 
0,221,//14,2.998046875V 
1,193,//15,3.0029296875V 
2,221,//16,3.0078125V 
0,143,//17,3.0126953125V 
2,189,//18,3.017578125V 
0,207,//19,3.0224609375V 
2,253,//20,3.02734375V 
2,207,//21,3.0322265625V 
0,159,//22,3.037109375V 
0,239,//23,3.0419921875V 
0,223,//24,3.046875V 
2,223,//25,3.0517578125V 
0,191,//26,3.056640625V 
1,147,//27,3.0615234375V 
0,255,//28,3.06640625V 
3,127,//29,3.0712890625V 
2,255,//30,3.076171875V 
1,179,//31,3.0810546875V 
4,149,//32,3.0859375V 
1,243,//33,3.0908203125V 
4,213,//34,3.095703125V 
3,243,//35,3.1005859375V 
4,181,//36,3.10546875V 
4,135,//37,3.1103515625V 
4,245,//38,3.115234375V 
4,199,//39,3.1201171875V 
6,245,//40,3.125V 
4,151,//41,3.1298828125V 
12,151,//42,3.134765625V 
4,215,//43,3.1396484375V 
12,215,//44,3.14453125V 
4,183,//45,3.1494140625V 
4,187,//46,3.154296875V 
6,187,//47,3.1591796875V 
4,247,//48,3.1640625V 
6,247,//49,3.1689453125V 
6,251,//50,3.173828125V 
36,247,//51,3.1787109375V 
68,181,//52,3.18359375V 
38,247,//53,3.1884765625V 
68,249,//54,3.193359375V 
68,199,//55,3.1982421875V 
76,199,//56,3.203125V 
1,133,//57,3.2080078125V 
9,133,//58,3.212890625V 
1,197,//59,3.2177734375V 
9,197,//60,3.22265625V 
1,149,//61,3.2275390625V 
9,149,//62,3.232421875V 
1,213,//63,3.2373046875V 
9,213,//64,3.2421875V 
3,213,//65,3.2470703125V 
1,135,//66,3.251953125V 
3,181,//67,3.2568359375V 
1,199,//68,3.26171875V 
3,245,//69,3.2666015625V 
3,199,//70,3.271484375V 
1,151,//71,3.2763671875V 
3,151,//72,3.28125V 
1,215,//73,3.2861328125V 
3,215,//74,3.291015625V 
1,183,//75,3.2958984375V 
4,157,//76,3.30078125V 
1,247,//77,3.3056640625V 
4,221,//78,3.310546875V 
3,247,//79,3.3154296875V 
4,189,//80,3.3203125V 
4,143,//81,3.3251953125V 
4,253,//82,3.330078125V 
4,207,//83,3.3349609375V 
6,253,//84,3.33984375V 
4,159,//85,3.3447265625V 
5,131,//86,3.349609375V 
4,223,//87,3.3544921875V 
5,195,//88,3.359375V 
6,223,//89,3.3642578125V 
4,191,//90,3.369140625V 
12,191,//91,3.3740234375V 
4,255,//92,3.37890625V 
12,255,//93,3.3837890625V 
6,255,//94,3.388671875V 
5,179,//95,3.3935546875V 
13,179,//96,3.3984375V 
5,243,//97,3.4033203125V 
13,243,//98,3.408203125V 
7,243,//99,3.4130859375V 
15,243,//100,3.41796875V 
1,141,//101,3.4228515625V 
9,141,//102,3.427734375V 
1,205,//103,3.4326171875V 
9,205,//104,3.4375V 
3,205,//105,3.4423828125V 
1,157,//106,3.447265625V 
3,157,//107,3.4521484375V 
1,221,//108,3.45703125V 
3,221,//109,3.4619140625V 
1,189,//110,3.466796875V 
1,143,//111,3.4716796875V 
1,253,//112,3.4765625V 
1,207,//113,3.4814453125V 
3,207,//114,3.486328125V 
1,159,//115,3.4912109375V 
9,159,//116,3.49609375V 
1,223,//117,3.5009765625V 
9,223,//118,3.505859375V 
1,191,//119,3.5107421875V 
9,191,//120,3.515625V 
1,255,//121,3.5205078125V 
9,255,//122,3.525390625V 
3,255,//123,3.5302734375V 
11,255,//124,3.53515625V 
5,149,//125,3.5400390625V 
13,149,//126,3.544921875V 
5,213,//127,3.5498046875V 
7,149,//128,3.5546875V 
7,233,//129,3.5595703125V 
5,135,//130,3.564453125V 
13,135,//131,3.5693359375V 
5,199,//132,3.57421875V 
13,199,//133,3.5791015625V 
7,203,//134,3.583984375V 
5,151,//135,3.5888671875V 
13,151,//136,3.59375V 
5,215,//137,3.5986328125V 
13,215,//138,3.603515625V 
5,183,//139,3.6083984375V 
13,183,//140,3.61328125V 
5,247,//141,3.6181640625V 
13,247,//142,3.623046875V 
7,247,//143,3.6279296875V 
15,247,//144,3.6328125V 
22,117,//145,3.6376953125V 
22,71,//146,3.642578125V 
20,23,//147,3.6474609375V 
22,39,//148,3.65234375V 
20,87,//149,3.6572265625V 
22,87,//150,3.662109375V 
20,55,//151,3.6669921875V 
28,119,//152,3.671875V 
20,119,//153,3.6767578125V 
30,119,//154,3.681640625V 
22,119,//155,3.6865234375V 
52,119,//156,3.69140625V 
60,119,//157,3.6962890625V 
54,119,//158,3.701171875V 
62,119,//159,3.7060546875V 
71,247,//160,3.7109375V 
86,53,//161,3.7158203125V 
24,133,//162,3.720703125V 
16,133,//163,3.7255859375V 
24,197,//164,3.73046875V 
5,141,//165,3.7353515625V 
13,141,//166,3.740234375V 
5,205,//167,3.7451171875V 
7,141,//168,3.75V 
7,205,//169,3.7548828125V 
5,157,//170,3.759765625V 
13,157,//171,3.7646484375V 
5,221,//172,3.76953125V 
13,221,//173,3.7744140625V 
5,189,//174,3.779296875V 
5,143,//175,3.7841796875V 
5,253,//176,3.7890625V 
5,207,//177,3.7939453125V 
7,253,//178,3.798828125V 
5,159,//179,3.8037109375V 
13,159,//180,3.80859375V 
5,223,//181,3.8134765625V 
13,223,//182,3.818359375V 
7,223,//183,3.8232421875V 
5,191,//184,3.828125V 
18,247,//185,3.8330078125V 
5,255,//186,3.837890625V 
20,15,//187,3.8427734375V 
7,255,//188,3.84765625V 
15,255,//189,3.8525390625V 
22,79,//190,3.857421875V 
20,47,//191,3.8623046875V 
20,31,//192,3.8671875V 
20,95,//193,3.8720703125V 
20,195,//194,3.876953125V 
22,95,//195,3.8818359375V 
20,63,//196,3.88671875V 
22,63,//197,3.8916015625V 
20,127,//198,3.896484375V 
20,211,//199,3.9013671875V 
22,211,//200,3.90625V 
20,179,//201,3.9111328125V 
22,179,//202,3.916015625V 
20,243,//203,3.9208984375V 
22,243,//204,3.92578125V 
60,179,//205,3.9306640625V 
25,13,//206,3.935546875V 
16,141,//207,3.9404296875V 
25,77,//208,3.9453125V 
16,205,//209,3.9501953125V 
26,205,//210,3.955078125V 
16,173,//211,3.9599609375V 
16,157,//212,3.96484375V 
24,221,//213,3.9697265625V 
16,221,//214,3.974609375V 
25,61,//215,3.9794921875V 
16,143,//216,3.984375V 
17,15,//217,3.9892578125V 
16,253,//218,3.994140625V 
16,207,//219,3.9990234375V 
18,253,//220,4.00390625V 
16,159,//221,4.0087890625V 
17,131,//222,4.013671875V 
16,223,//223,4.0185546875V 
26,223,//224,4.0234375V 
16,191,//225,4.0283203125V 
17,147,//226,4.033203125V 
16,255,//227,4.0380859375V 
17,211,//228,4.04296875V 
18,255,//229,4.0478515625V 
17,179,//230,4.052734375V 
20,165,//231,4.0576171875V 
17,243,//232,4.0625V 
20,213,//233,4.0673828125V 
19,243,//234,4.072265625V 
22,213,//235,4.0771484375V 
20,135,//236,4.08203125V 
22,181,//237,4.0869140625V 
20,199,//238,4.091796875V 
22,245,//239,4.0966796875V 
22,199,//240,4.1015625V 
20,151,//241,4.1064453125V 
22,151,//242,4.111328125V 
20,215,//243,4.1162109375V 
22,215,//244,4.12109375V 
20,183,//245,4.1259765625V 
28,247,//246,4.130859375V 
20,247,//247,4.1357421875V 
23,123,//248,4.140625V 
22,247,//249,4.1455078125V 
52,247,//250,4.150390625V 
60,247,//251,4.1552734375V 
54,247,//252,4.16015625V 
62,247,//253,4.1650390625V 
84,135,//254,4.169921875V 
85,7,//255,4.1748046875V 
25,133,//256,4.1796875V 
17,133,//257,4.1845703125V 
25,197,//258,4.189453125V 
17,197,//259,4.1943359375V 
19,201,//260,4.19921875V 
17,149,//261,4.2041015625V 
25,217,//262,4.208984375V 
17,213,//263,4.2138671875V 
27,213,//264,4.21875V 
17,185,//265,4.2236328125V 
17,135,//266,4.228515625V 
19,181,//267,4.2333984375V 
17,199,//268,4.23828125V 
19,245,//269,4.2431640625V 
17,151,//270,4.248046875V 
27,155,//271,4.2529296875V 
17,215,//272,4.2578125V 
17,219,//273,4.2626953125V 
19,219,//274,4.267578125V 
17,183,//275,4.2724609375V 
20,157,//276,4.27734375V 
17,247,//277,4.2822265625V 
20,221,//278,4.287109375V 
19,247,//279,4.2919921875V 
21,61,//280,4.296875V 
20,143,//281,4.3017578125V 
22,189,//282,4.306640625V 
20,207,//283,4.3115234375V 
22,207,//284,4.31640625V 
20,159,//285,4.3212890625V 
20,175,//286,4.326171875V 
20,239,//287,4.3310546875V 
20,223,//288,4.3359375V 
22,223,//289,4.3408203125V 
20,191,//290,4.345703125V 
23,63,//291,4.3505859375V 
20,255,//292,4.35546875V 
22,255,//293,4.3603515625V 
23,211,//294,4.365234375V 
21,179,//295,4.3701171875V 
23,179,//296,4.375V 
21,243,//297,4.3798828125V 
23,243,//298,4.384765625V 
31,243,//299,4.3896484375V 
53,243,//300,4.39453125V 
17,141,//301,4.3994140625V 
27,141,//302,4.404296875V 
17,205,//303,4.4091796875V 
27,205,//304,4.4140625V 
19,205,//305,4.4189453125V 
17,157,//306,4.423828125V 
25,221,//307,4.4287109375V 
17,221,//308,4.43359375V 
27,221,//309,4.4384765625V 
17,189,//310,4.443359375V 
17,143,//311,4.4482421875V 
17,253,//312,4.453125V 
17,207,//313,4.4580078125V 
19,253,//314,4.462890625V 
17,159,//315,4.4677734375V 
25,239,//316,4.47265625V 
17,223,//317,4.4775390625V 
27,223,//318,4.482421875V 
19,223,//319,4.4873046875V 
17,191,//320,4.4921875V 
17,255,//321,4.4970703125V 
51,223,//322,4.501953125V 
19,255,//323,4.5068359375V 
57,191,//324,4.51171875V 
23,197,//325,4.5166015625V 
21,149,//326,4.521484375V 
23,149,//327,4.5263671875V 
21,213,//328,4.53125V 
23,213,//329,4.5361328125V 
21,139,//330,4.541015625V 
21,135,//331,4.5458984375V 
21,203,//332,4.55078125V 
21,199,//333,4.5556640625V 
23,199,//334,4.560546875V 
21,151,//335,4.5654296875V 
23,151,//336,4.5703125V 
21,215,//337,4.5751953125V 
23,219,//338,4.580078125V 
21,183,//339,4.5849609375V 
61,151,//340,4.58984375V 
21,247,//341,4.5947265625V 
61,215,//342,4.599609375V 
23,247,//343,4.6044921875V 
61,183,//344,4.609375V 
53,247,//345,4.6142578125V 
61,247,//346,4.619140625V 
55,247,//347,4.6240234375V 
63,247,//348,4.62890625V 
85,135,//349,4.6337890625V 
87,181,//350,4.638671875V 
85,199,//351,4.6435546875V 
87,245,//352,4.6484375V 
87,199,//353,4.6533203125V 
85,151,//354,4.658203125V 
87,167,//355,4.6630859375V 
85,215,//356,4.66796875V 
87,219,//357,4.6728515625V 
85,183,//358,4.677734375V 
117,151,//359,4.6826171875V 
85,247,//360,4.6875V 
117,215,//361,4.6923828125V 
87,247,//362,4.697265625V 
117,183,//363,4.7021484375V 
125,183,//364,4.70703125V 
117,247,//365,4.7119140625V 
21,141,//366,4.716796875V 
23,141,//367,4.7216796875V 
21,205,//368,4.7265625V 
23,205,//369,4.7314453125V 
21,157,//370,4.736328125V 
61,141,//371,4.7412109375V 
21,221,//372,4.74609375V 
61,205,//373,4.7509765625V 
23,221,//374,4.755859375V 
21,143,//375,4.7607421875V 
23,189,//376,4.765625V 
21,207,//377,4.7705078125V 
23,253,//378,4.775390625V 
23,207,//379,4.7802734375V 
21,159,//380,4.78515625V 
23,159,//381,4.7900390625V 
21,223,//382,4.794921875V 
23,239,//383,4.7998046875V 
21,191,//384,4.8046875V 
61,159,//385,4.8095703125V 
21,255,//386,4.814453125V 
61,223,//387,4.8193359375V 
23,255,//388,4.82421875V 
53,191,//389,4.8291015625V 
53,255,//390,4.833984375V 
55,191,//391,4.8388671875V 
61,255,//392,4.84375V 
55,255,//393,4.8486328125V 
85,143,//394,4.853515625V 
93,143,//395,4.8583984375V 
85,207,//396,4.86328125V 
93,207,//397,4.8681640625V 
87,207,//398,4.873046875V 
85,159,//399,4.8779296875V 
117,143,//400,4.8828125V 
85,223,//401,4.8876953125V 
117,207,//402,4.892578125V 
85,191,//403,4.8974609375V 
93,191,//404,4.90234375V 
85,255,//405,4.9072265625V 
93,255,//406,4.912109375V 
87,255,//407,4.9169921875V 
95,255,//408,4.921875V 
117,191,//409,4.9267578125V 
125,191,//410,4.931640625V 
117,255,//411,4.9365234375V 
125,255,//412,4.94140625V 
119,255,//413,4.9462890625V 
127,255,//414,4.951171875V 
221,255,//415,4.9560546875V 
215,255,//416,4.9609375V 
223,255,//417,4.9658203125V 
245,191,//418,4.970703125V 
253,191,//419,4.9755859375V 
245,255,//420,4.98046875V 
253,255,//421,4.9853515625V 
247,255,//422,4.990234375V 
255,255,//423,4.9951171875V 
};

#define DDR_STR_ON   DDRA  |=  _BV(6)
#define PORT_STR_ON  PORTA |=  _BV(6)
#define PORT_STR_OFF PORTA &= ~_BV(6)

#define DDR_DAT_ON   DDRA  |=  _BV(7)
#define PORT_DAT_ON  PORTA |=  _BV(7)
#define PORT_DAT_OFF PORTA &= ~_BV(7)

#define DDR_OE_ON    DDRB  |=  _BV(2)
#define PORT_OE_ON   PORTB |=  _BV(2)
#define PORT_OE_OFF  PORTB &= ~_BV(2)


#define DDR_CLK_ON   DDRA  |=  _BV(5)
#define PORT_CLK_ON  PORTA |=  _BV(5)
#define PORT_CLK_OFF PORTA &= ~_BV(5)

#define CUR_TIMING TIMING__8M_TCCR1B_1_115200
#define TCCR1B_Value 1

PROGMEM prog_uint16_t TIMING__8M_TCCR1B_1_115200[] = {   69,  138,  208,  277,  347,  416,  486,  555,  625,  694};

#define currTick ((TIFR1 & _BV(TOV1))?0x0FFFF:TCNT1)

#define DDR_Send DDRB
#define PORT_Send PORTB
#define BIT_Send _BV(0)

#define DDR_Recv DDRB
#define PIN_Recv PINB
#define BIT_Recv _BV(1)



void SendByte(uint8_t data){
  for(uint8_t i=0;i<8;i++)
  {
    if(data&1)
    {
      PORT_DAT_ON;
    }
    else
    {
      PORT_DAT_OFF;
    }
    data>>=1;
    PORT_CLK_ON; //shift clock up
    PORT_CLK_OFF; //shift clock down
  }
}
void sendData(uint8_t ByteA, uint8_t ByteB){
  SendByte(ByteA);
  SendByte(ByteB);
  PORT_STR_ON;
  PORT_STR_OFF;
}
void setVoltage(uint16_t idx){
  SendByte(pgm_read_byte_near(Voltage+(idx<<1)));
  SendByte(pgm_read_byte_near(Voltage+(idx<<1)+1));
  PORT_STR_ON;
  PORT_STR_OFF;
}

void wait(uint32_t n){
	{
		uint32_t i = 0;
		for(i=0;i<n;i++)
		{
			asm volatile("nop");
		}
	}
  
}


uint16_t getAnalog(){//0~1024
	ADCSRA = _BV(ADEN) | _BV(ADPS2) | _BV(ADPS1) | _BV(ADPS0);//ADATE ADIF ADIE
	DIDR0 |= _BV(ADC6D);
	ADCSRB = 0;

	uint8_t i;
	uint32_t val = 0;
	ADCSRA |= _BV(ADSC);while(ADCSRA & _BV(ADSC));
	ADCSRA |= _BV(ADSC);while(ADCSRA & _BV(ADSC));
	for(i=0;i<64;i++){
		ADCSRA |= _BV(ADSC);while(ADCSRA & _BV(ADSC));
		uint16_t v = ADC;
		val += v;
	}
	val = val >> 6;
  return (uint16_t)val;
}
uint16_t getInitVal(){
	ADMUX = 4;
  getAnalog();
}
uint16_t getCurrent(){
	ADMUX = 3;
  ADMUX |= _BV(REFS1);
  getAnalog();
}
uint16_t getVoltage(){
	ADMUX = 2;
  getAnalog();
}
uint16_t getVoltage10(){
	ADMUX = 1;
  getAnalog();
}


void SerialInit(){
	//UCSR0B = 0;//not forget turnoff usart0 on mega328p
	DDR_Send |= BIT_Send;
	DDR_Recv &= ~BIT_Recv;
	PORT_Send |= BIT_Send;
	TCCR1A = 0;
	TCCR1C = 0;
	TIMSK1 = 0;
}

void SerialSend(uint8_t val){
	cli();
	TCCR1B = TCCR1B_Value;
	TCNT1 = 0;
	uint16_t timing;
	prog_uint16_t* pTiming = CUR_TIMING;
	PORT_Send &= ~BIT_Send;timing = pgm_read_word_near(pTiming++);while(TCNT1<timing);//startbit
	uint8_t chkbit = 0x01;
	for(uint8_t i = 8 ; i > 0 ; i--)
	{
		if(val&chkbit){PORT_Send |= BIT_Send;}else{PORT_Send &= ~BIT_Send;}chkbit<<=1;timing = pgm_read_word_near(pTiming++);while(TCNT1<timing);
	}
	PORT_Send |= BIT_Send;timing = pgm_read_word_near(pTiming);while(TCNT1<timing);
	sei();
}

PROGMEM prog_uint32_t num10s[] = {
1000000000,
100000000,
10000000,
1000000,
100000,
10000,
1000,
100,
10,
1,
};

void SendInt(uint32_t val, uint8_t digits){
	uint32_t num = val;
	for(uint8_t idx = 0; idx < 10 ; idx++)
	{
		uint8_t outNum = 0;
		uint32_t CmpNum = pgm_read_dword_near(num10s + idx);
		for(uint8_t i = 0; i < 10 ; i++)
		{
			if(num>=CmpNum)
			{
				num -= CmpNum;
				outNum++;
			}
			else
			{
				break;
			}
		}
		if(10-idx<=digits){
			SerialSend('0' + outNum);
		}
	}
}
uint16_t cmax = 0;
uint16_t cmin = 0;
uint16_t mosVolt = 0;//0~311  2v-5v
uint16_t curr = 0;
uint16_t volt = 0;
uint8_t started = 0;

void report(){
    SerialSend('c');SerialSend(':');SendInt(curr,5);SerialSend('\t');
    SerialSend('v');SerialSend(':');SendInt(volt,5);SerialSend('\t');
    SerialSend('m');SerialSend(':');SendInt(mosVolt,5);SerialSend('\t');
    SerialSend('u');SerialSend(':');SendInt(cmax,5);SerialSend('\t');
    SerialSend('d');SerialSend(':');SendInt(cmin,5);SerialSend('\t');
    SerialSend('\n');
}

int main(void) {
	CLKPR = 128;//The CLKPCE bit must be written to logic one to enable change of the CLKPS bits. The CLKPCE bit is only updated when the other bits in CLKPR are simultaniosly written to zero.
	//CLKPR = 3;//1/8
	CLKPR = 0;//1/1 //8MHz
  rst:
	SerialInit();
	DDR_DAT_ON;
	DDR_CLK_ON;
	DDR_STR_ON;
	DDR_OE_ON ;
	PORT_OE_OFF;
  DDR_Recv &= ~BIT_Recv;
  sendData(0, 0);
  
  //开始
  while(PIN_Recv & BIT_Recv){
      uint16_t val;
      val = getInitVal();
      
      cmax = val>>1;//0~512
      cmin = cmax>>3;//
      cmin = cmax - cmin;
      if(cmin>2)
      {
        cmin--;
      }
      
      report();
      
      wait(10000);
  }
  
	{
		for(;;)
		{
      curr = getCurrent();
      volt = getVoltage();
      
      if(curr<cmin){
        if(mosVolt<423){//0~423
          mosVolt++;
        }
      }
			else{
				started = 1;
			}
	  
	  
      if(curr>cmax){
        if(mosVolt>0){
          mosVolt--;
        }
      }

      setVoltage(mosVolt);
      
      report();
      if(volt<614){//3.00v stop
        sendData(0, 0);
        SerialSend('S');SerialSend('T');SerialSend('O');SerialSend('P');SerialSend('\n');
        while(PIN_Recv & BIT_Recv);
        goto rst;
      }
      
      //val = getVoltage10();
      //SerialSend('1');SerialSend(':');SendInt(val,5);SerialSend('\t');
			if(started){
				wait(100000);
			}
			else
			{
				wait(20000);
			}
		}
	}
}
