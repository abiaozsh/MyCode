char const data1[256] = {
// 0	1	2	3	4	5	6	7	8	9	A	B	C	D	E	F
//0
0x07,0x00,0x03,0x00,0x03,0x00,0x06,0x00,0x25,0x42,0x00,0x00,0x00,0x00,0x00,0x00, //0
0x07,0x00,0x03,0x00,0x03,0x00,0x06,0x00,0x25,0x42,0x00,0x00,0x00,0x00,0x00,0x00, //1 1
0x9B,0x00,0xA8,0x00,0x00,0x00,0x00,0x00,0x9B,0x00,0xA8,0x00,0x00,0x00,0x00,0x00, //2
0x9B,0x00,0xA8,0x00,0x00,0x00,0x00,0x00,0x9B,0x00,0xA8,0x00,0x00,0x00,0x00,0x00, //3 2
0x70,0x00,0xAB,0x00,0x06,0x00,0x00,0x00,0x95,0x00,0x80,0x04,0x00,0x00,0x00,0x00, //4
0x70,0x00,0xAB,0x00,0x06,0x00,0x00,0x00,0x95,0x00,0x80,0x04,0x00,0x00,0x00,0x00, //5 3
0x07,0x00,0x98,0x00,0x60,0x00,0x00,0x00,0xB0,0x04,0xA5,0x00,0x00,0x00,0x00,0x00, //6
0x07,0x00,0x98,0x00,0x60,0x00,0x00,0x00,0xB0,0x04,0xA5,0x00,0x00,0x00,0x00,0x00, //7 4
0x07,0x00,0x03,0x00,0x48,0x00,0x00,0x00,0x00,0x07,0x25,0x0A,0x00,0x00,0x00,0x00, //8
0x95,0x00,0x30,0x00,0x60,0x00,0x00,0x00,0x2B,0x04,0x06,0x00,0x00,0x00,0x00,0x00, //9 5
0x4B,0x00,0x03,0x00,0x06,0x00,0x00,0x00,0x07,0x00,0x28,0x04,0x00,0x00,0x00,0x00, //A
0x70,0x00,0x30,0x00,0xA5,0x00,0x00,0x00,0x25,0x09,0x00,0x06,0x00,0x00,0x00,0x00, //B 6
0x70,0x00,0xF5,0x04,0x00,0x00,0x00,0x00,0x70,0x00,0xC5,0x00,0x60,0x00,0x00,0x00, //C
0xD5,0x04,0x60,0x00,0x00,0x00,0x00,0x00,0x07,0x00,0x4E,0x00,0x06,0x00,0x00,0x00, //D 7
0x00,0x01,0x05,0x03,0x01,0x05,0x06,0x07,0x08,0x07,0x06,0x0B,0x03,0x0B,0x0E,0x08, //E chg
0x00,0x01,0x04,0x03,0x04,0x01,0x06,0x07,0x06,0x09,0x0A,0x07,0x0C,0x09,0x03,0x0A  //F chg
};
char const data2[256] = {
0x11,0x11,0x04,0x00,0x11,0x11,0x04,0x00,0x22,0x00,0x22,0x00,0x22,0x00,0x22,0x00, //0 
0x22,0x01,0x32,0x00,0x22,0x01,0x32,0x00,0x21,0x02,0x23,0x00,0x21,0x02,0x23,0x00, //1
0x11,0x02,0x33,0x00,0x22,0x02,0x13,0x00,0x12,0x01,0x31,0x00,0x22,0x02,0x33,0x00, //2 
0x32,0x00,0x22,0x02,0x23,0x00,0x21,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, //3
0x04,0x01,0x04,0x01,0x02,0x02,0x02,0x02,0x03,0x02,0x03,0x02,0x03,0x02,0x03,0x02, //4
0x03,0x02,0x03,0x02,0x03,0x02,0x03,0x02,0x02,0x03,0x02,0x03,0x00,0x00,0x00,0x00, //5
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, //6
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, //7 free
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,//<<rnd
0x00,0x00,0x01,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,//<<rnd
0x11,0x11,0x11,0x11,0x12,0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x22,//<<rnd
0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x33,0x33,0x33,0x33,0x33,0x33,0x33,0x33,0x33,//<<rnd
0x33,0x33,0x33,0x33,0x33,0x33,0x33,0x33,0x33,0x44,0x44,0x44,0x44,0x44,0x44,0x44,//<<rnd
0x44,0x44,0x44,0x44,0x44,0x44,0x44,0x44,0x44,0x44,0x44,0x45,0x55,0x55,0x55,0x55,//<<rnd
0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x56,0x66,0x66,//<<rnd
0x66,0x66,0x66,0x66,0x66,0x66,0x66,0x66,0x66,0x66,0x66,0x66,0x66,0x66,0x66,0x66 //<<rnd
};
char const img1[256] = {
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,//0
0xFF,0xFF,0xC3,0xC3,0xC3,0xC3,0xFF,0xFF,0x01,0x03,0x3F,0x3F,0x3F,0x3F,0x7F,0xFF,//1
0xC3,0xC3,0xC3,0xC3,0xC3,0xC3,0xC3,0xC3,0x3F,0x3F,0x3F,0x3F,0x3F,0x3F,0x3F,0x3F,//2
0xFF,0xFF,0x00,0x00,0x00,0x00,0xFF,0xFF,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,//3
0xC3,0xC3,0xC3,0xC3,0xC3,0xC3,0xFF,0xFF,0x3F,0x3F,0x3F,0x3F,0x3F,0x3F,0x7F,0xFF,//4
0xFF,0xFF,0xC3,0xC3,0xC3,0xC3,0xC3,0xC3,0x01,0x03,0x3F,0x3F,0x3F,0x3F,0x3F,0x3F,//5
0xFF,0xFF,0x03,0x03,0x03,0x03,0xFF,0xFF,0x01,0x03,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,//6
0xFF,0xFF,0xC0,0xC0,0xC0,0xC0,0xFF,0xFF,0x00,0x00,0x3F,0x3F,0x3F,0x3F,0x7F,0xFF,//7
0xFF,0xFF,0x03,0x03,0x03,0x03,0xC3,0xC3,0x01,0x03,0xFF,0xFF,0xFF,0xFF,0xBF,0x3F,//8
0xC3,0xC3,0xC0,0xC0,0xC0,0xC0,0xFF,0xFF,0x3E,0x3C,0x3F,0x3F,0x3F,0x3F,0x7F,0xFF,//9
0xC3,0xC3,0x03,0x03,0x03,0x03,0xFF,0xFF,0x3F,0x3F,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,//10
0xFF,0xFF,0xC0,0xC0,0xC0,0xC0,0xC3,0xC3,0x00,0x00,0x3F,0x3F,0x3F,0x3F,0x3F,0x3F,//11
0xC3,0xC3,0x00,0x00,0x00,0x00,0xFF,0xFF,0x3E,0x3C,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,//12
0xC3,0xC3,0xC0,0xC0,0xC0,0xC0,0xC3,0xC3,0x3E,0x3C,0x3F,0x3F,0x3F,0x3F,0x3F,0x3F,//13
0xFF,0xFF,0x00,0x00,0x00,0x00,0xC3,0xC3,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xBF,0x3F,//14
0xC3,0xC3,0x03,0x03,0x03,0x03,0xC3,0xC3,0x3F,0x3F,0xFF,0xFF,0xFF,0xFF,0xBF,0x3F,//15
};
char const img2[256] = {
0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,//0 MM
0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x38,0x24,0x24,0x38,0x20,0x20,0x20,0x20,//1 P
0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x44,0x44,0x44,0x44,0x44,0x44,0x44,0x38,//2 U
0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x3C,0x40,0x40,0x38,0x04,0x04,0x04,0x78,//3 S
0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x44,0x44,0x44,0x7C,0x44,0x44,0x44,0x44,//4 H
0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x10,0x28,0x44,0x7C,0x44,0x44,0x44,0x44,//5 A
0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x44,0x48,0x50,0x60,0x50,0x48,0x44,0x44,//6 K
0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x7C,0x40,0x40,0x7C,0x40,0x40,0x40,0x7C,//7 E
0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x44,0x28,0x28,0x10,0x10,0x10,0x10,0x10,//8 Y
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,//9
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,//A
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,//B
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,//C
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,//D
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,//E
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00 //F
};

char rand0;
char rand1;
char rand2;
char rand3;

char Board[100];
char DrawBuff[16];//sp*4 //10*data+address

signed char PosX;
signed char PosY;
char NextShapeNo;
char NowShapeNo;
char NowDirectionNo;

char key1;



void waitvblank(){
	if(((*(char*)(0x2002))&128)!=0)
	{
		while(((*(char*)(0x2002))&128)!=0)
		{
		}
		while(((*(char*)(0x2002))&128)==0)
		{
		}
	}
	else
	{
		while(((*(char*)(0x2002))&128)==0)
		{
		}
	}
}
void nmi(){

}
void rnd(){
asm("clc");
asm("lda _rand0");//SEED *= $01010101
asm("adc _rand1");
asm("sta _rand1");
asm("adc _rand2");
asm("sta _rand2");
asm("adc _rand3");
asm("sta _rand3");
asm("clc       ");
asm("lda _rand0");//SEED += $31415927
asm("adc #$27  ");
asm("sta _rand0");
asm("lda _rand1");
asm("adc #$59  ");
asm("sta _rand1");
asm("pha       ");
asm("lda _rand2");
asm("adc #$41  ");
asm("sta _rand2");
asm("and #$7f  ");//Suppress sign bit (make it positive)
asm("tax       ");
asm("lda _rand3");
asm("adc #$31  ");
asm("sta _rand3");
asm("pla       ");//return bit 8-22 in (X,A)
}

char getBlock_i;
char getBlock_j;
char getBlock_ret;
char getBlock_temp;
char getBlock_idx;
void getNowBlock(){
	//char idx = (NowShapeNo<<5)+(NowDirectionNo<<3)+(getBlock_i<<1)+(getBlock_j>>1);
	//getBlock_idx = NowShapeNo;
	asm("lda _NowShapeNo");
	asm("sta _getBlock_idx");
	//getBlock_idx <<= 5;
	asm("asl _getBlock_idx");
	asm("asl _getBlock_idx");
	asm("asl _getBlock_idx");
	asm("asl _getBlock_idx");
	asm("asl _getBlock_idx");
		
	//getBlock_temp = NowDirectionNo;
	asm("lda _NowDirectionNo");
	asm("sta _getBlock_temp");
	//getBlock_temp <<= 3;
	asm("asl _getBlock_temp");
	asm("asl _getBlock_temp");
	asm("asl _getBlock_temp");
	//getBlock_idx += getBlock_temp;
	asm("lda _getBlock_idx");
	asm("clc");
	asm("adc _getBlock_temp");
	asm("sta _getBlock_idx");

	//getBlock_temp = getBlock_i;
	asm("lda _getBlock_i");
	asm("sta _getBlock_temp");
	//getBlock_temp <<= 1;
	asm("asl _getBlock_temp");
	//getBlock_idx += getBlock_temp;
	asm("lda _getBlock_idx");
	asm("clc");
	asm("adc _getBlock_temp");
	asm("sta _getBlock_idx");
	
	//getBlock_temp = getBlock_j;
	asm("lda _getBlock_j");
	asm("sta _getBlock_temp");
	//getBlock_temp >>= 1;
	asm("lsr _getBlock_temp");
	//getBlock_idx += getBlock_temp;
	asm("lda _getBlock_idx");
	asm("clc");
	asm("adc _getBlock_temp");
	asm("sta _getBlock_idx");
	
	//getBlock_temp = getBlock_j & 1;
	asm("lda _getBlock_j");
	asm("and #$01");
	asm("sta _getBlock_temp");
	
	if(getBlock_temp)
	{
		//getBlock_ret = (data1[getBlock_idx]>>4)&0x0F;
		asm("ldx _getBlock_idx");
		asm("lda _data1,X");
		asm("sta _getBlock_ret");
		asm("lsr _getBlock_ret");
		asm("lsr _getBlock_ret");
		asm("lsr _getBlock_ret");
		asm("lsr _getBlock_ret");
	}
	else
	{
		//getBlock_ret = data1[getBlock_idx]&0x0F;
		asm("ldx _getBlock_idx");
		asm("lda _data1,X");
		asm("and #$0F");
		asm("sta _getBlock_ret");
	}
}
void getNextBlock(){
	//char idx = (NextShapeNo<<5)+(i<<1)+(j>>1);
	//getBlock_idx = NextShapeNo;
	asm("lda _NextShapeNo");
	asm("sta _getBlock_idx");
	//getBlock_idx <<= 5;
	asm("asl _getBlock_idx");
	asm("asl _getBlock_idx");
	asm("asl _getBlock_idx");
	asm("asl _getBlock_idx");
	asm("asl _getBlock_idx");

	//getBlock_temp = getBlock_i;
	asm("lda _getBlock_i");
	asm("sta _getBlock_temp");
	//getBlock_temp <<= 1;
	asm("asl _getBlock_temp");
	//getBlock_idx += getBlock_temp;
	asm("lda _getBlock_idx");
	asm("clc");
	asm("adc _getBlock_temp");
	asm("sta _getBlock_idx");

	//getBlock_temp = getBlock_j;
	asm("lda _getBlock_j");
	asm("sta _getBlock_temp");
	//getBlock_temp >>= 1;
	asm("lsr _getBlock_temp");
	//getBlock_idx += getBlock_temp;
	asm("lda _getBlock_idx");
	asm("clc");
	asm("adc _getBlock_temp");
	asm("sta _getBlock_idx");
	
	//getBlock_temp = getBlock_j & 1;
	asm("lda _getBlock_j");
	asm("and #$01");
	asm("sta _getBlock_temp");

	if(getBlock_temp)
	{
		//getBlock_ret = (data1[getBlock_idx]>>4)&0x0F;
		asm("ldx _getBlock_idx");
		asm("lda _data1,X");
		asm("sta _getBlock_ret");
		asm("lsr _getBlock_ret");
		asm("lsr _getBlock_ret");
		asm("lsr _getBlock_ret");
		asm("lsr _getBlock_ret");
	}
	else
	{
		//getBlock_ret = data1[getBlock_idx]&0x0F;
		asm("ldx _getBlock_idx");
		asm("lda _data1,X");
		asm("and #$0F");
		asm("sta _getBlock_ret");
	}
}
void getNowBottom(){
	//char idx = (NowShapeNo<<3)+(NowDirectionNo<<1)+(j>>1);
	//getBlock_idx = NowShapeNo;
	asm("lda _NowShapeNo");
	asm("sta _getBlock_idx");
	//getBlock_idx <<= 3;
	asm("asl _getBlock_idx");
	asm("asl _getBlock_idx");
	asm("asl _getBlock_idx");
	
	//getBlock_temp = NowDirectionNo;
	asm("lda _NowDirectionNo");
	asm("sta _getBlock_temp");
	//getBlock_temp <<= 1;
	asm("asl _getBlock_temp");
	//getBlock_idx += getBlock_temp;
	asm("lda _getBlock_idx");
	asm("clc");
	asm("adc _getBlock_temp");
	asm("sta _getBlock_idx");

	//getBlock_temp = getBlock_j;
	asm("lda _getBlock_j");
	asm("sta _getBlock_temp");
	//getBlock_temp >>= 1;
	asm("lsr _getBlock_temp");
	//getBlock_idx += getBlock_temp;
	asm("lda _getBlock_idx");
	asm("clc");
	asm("adc _getBlock_temp");
	asm("sta _getBlock_idx");
	
	//getBlock_temp = getBlock_j & 1;
	asm("lda _getBlock_j");
	asm("and #$01");
	asm("sta _getBlock_temp");
	
	if(getBlock_temp)
	{
		//getBlock_ret = (data2[getBlock_idx]>>4)&0x0F;
		asm("ldx _getBlock_idx");
		asm("lda _data2,X");
		asm("sta _getBlock_ret");
		asm("lsr _getBlock_ret");
		asm("lsr _getBlock_ret");
		asm("lsr _getBlock_ret");
		asm("lsr _getBlock_ret");
	}
	else
	{
		//getBlock_ret = data2[getBlock_idx]&0x0F;
		asm("ldx _getBlock_idx");
		asm("lda _data2,X");
		asm("and #$0F");
		asm("sta _getBlock_ret");
	}
}
char getNowLeft(){
	char idx = (NowShapeNo<<2)+NowDirectionNo+0x40;
	return data2[idx];
}

//x:0~9 y:0~19
void setBoard(int x,int y,int val){
	int base=(y<<2)+y;//x*5
	base=base+(x>>1);
	if((x & 0x01)==0)
		Board[base] = (Board[base] & 0xF0) | val;//low 4
	else
		Board[base] = (Board[base] & 0x0F) | (val<<4);//high 4
}
char getBoard(int x,int y){
	int base=(y<<2)+y;//x*5
	base=base+(x>>1);
	if((x & 0x01)==0)
		return Board[base] & 0x0F;//low 4
	else
		return Board[base] >> 4;//high 4
}
int getRnd7(){
	char v;
	rnd();
	v = data2[0x080+(rand2&0x7F)];
	if((rand2&0x80)==0)
	{
		return v&0x0F;
	}
	else
	{
		return (v>>4)&0x0F;
	}
	//return Math.floor(Math.random()*7);
}


void DrawNextShape(){
	int i,j,idx=0;
	for(i=0;i<4;i++)
	{
		for(j=0;j<4;j++)
		{
			int x,y;
			x = 12+i;
			y = 2+j;
			getBlock_i = i;
			getBlock_j = j;
			getNextBlock();
			if(getBlock_ret!=0)
			{
				DrawBuff[idx++]=((y+3)<<3)-1;
				DrawBuff[idx++]=getBlock_ret;
				DrawBuff[idx++]=0;
				DrawBuff[idx++]=(x+2)<<3;
			}
		}
	}
	waitvblank();
	*(char*)(0x2003)=16; //i<<2
	for(i=0;i<16;i++)
	{
		*(char*)(0x2004)=DrawBuff[i];
	}
}


//core
void ClearLine(){
	*(char*)(0x2007)=0;
	*(char*)(0x2007)=0;
	*(char*)(0x2007)=0;
	*(char*)(0x2007)=0;
	*(char*)(0x2007)=0;
	*(char*)(0x2007)=0;
	*(char*)(0x2007)=0;
	*(char*)(0x2007)=0;
	*(char*)(0x2007)=0;
	*(char*)(0x2007)=0;
	*(char*)(0x2005)=0;
	*(char*)(0x2005)=0;
	waitvblank();
}
void Clear(){
	char i;
	for(i=0;i<100;i++)
	{
		Board[i]=0;
	}
	waitvblank();
	*(char*)(0x2006)=0x20;
	*(char*)(0x2006)=0x62;
	ClearLine();
	*(char*)(0x2006)=0x20;
	*(char*)(0x2006)=0x82;
	ClearLine();
	*(char*)(0x2006)=0x20;
	*(char*)(0x2006)=0xA2;
	ClearLine();
	*(char*)(0x2006)=0x20;
	*(char*)(0x2006)=0xC2;
	ClearLine();
	*(char*)(0x2006)=0x20;
	*(char*)(0x2006)=0xE2;
	ClearLine();
	*(char*)(0x2006)=0x21;
	*(char*)(0x2006)=0x02;
	ClearLine();
	*(char*)(0x2006)=0x21;
	*(char*)(0x2006)=0x22;
	ClearLine();
	*(char*)(0x2006)=0x21;
	*(char*)(0x2006)=0x42;
	ClearLine();
	*(char*)(0x2006)=0x21;
	*(char*)(0x2006)=0x62;
	ClearLine();
	*(char*)(0x2006)=0x21;
	*(char*)(0x2006)=0x82;
	ClearLine();
	*(char*)(0x2006)=0x21;
	*(char*)(0x2006)=0xA2;
	ClearLine();
	*(char*)(0x2006)=0x21;
	*(char*)(0x2006)=0xC2;
	ClearLine();
	*(char*)(0x2006)=0x21;
	*(char*)(0x2006)=0xE2;
	ClearLine();
	*(char*)(0x2006)=0x22;
	*(char*)(0x2006)=0x02;
	ClearLine();
	*(char*)(0x2006)=0x22;
	*(char*)(0x2006)=0x22;
	ClearLine();
	*(char*)(0x2006)=0x22;
	*(char*)(0x2006)=0x42;
	ClearLine();
	*(char*)(0x2006)=0x22;
	*(char*)(0x2006)=0x62;
	ClearLine();
	*(char*)(0x2006)=0x22;
	*(char*)(0x2006)=0x82;
	ClearLine();
	*(char*)(0x2006)=0x22;
	*(char*)(0x2006)=0xA2;
	ClearLine();
	*(char*)(0x2006)=0x22;
	*(char*)(0x2006)=0xC2;
	ClearLine();
}

void NextShape(){
	NowShapeNo = NextShapeNo;
	NowDirectionNo = 0;
	PosY = 19;
	PosX = 3;
	NextShapeNo = getRnd7();
	DrawNextShape();
}
int Touch(){
	int i;
	for(i=0;i<4;i++)
	{
		getBlock_j = i;
		getNowBottom();
		if(getBlock_ret!=0)
		{
			if(getBlock_ret==PosY+1)
			{
				return 1;
			}
			if(getBoard(PosX+i,PosY-getBlock_ret)!=0)
			{
				return 1;
			}
		}
	}
	return 0;
}

void DrawShape(){
	int i,j,idx=0;
	for(i=0;i<4;i++)
	{
		for(j=0;j<4;j++)
		{
			int x,y;
			x = i+PosX;
			y = j+19-PosY;

			getBlock_i=i;
			getBlock_j=j;
			getNowBlock();
			if(getBlock_ret!=0)
			{
				DrawBuff[idx++]=((y+3)<<3)-1;
				DrawBuff[idx++]=getBlock_ret;
				DrawBuff[idx++]=0;
				DrawBuff[idx++]=(x+2)<<3;
			}
		}
	}
	waitvblank();
	*(char*)(0x2003)=0; //i<<2
	for(i=0;i<16;i++)
	{
		*(char*)(0x2004)=DrawBuff[i];
	}
}

void TouchDo(){
	int i,j,idx=0;
	//add to board
	for(i=0;i<4;i++)
	{
		for(j=0;j<4;j++)
		{
			int x=PosX+i;
			int y=PosY-j;
			getBlock_i=i;
			getBlock_j=j;
			getNowBlock();
			if(getBlock_ret!=0)
			{
				setBoard(x,y,getBlock_ret);
				{
					int base = 0x2020;
					base+=(19-y+2)<<5;
					base+=(x+2);
					DrawBuff[idx++]=base>>8;
					DrawBuff[idx++]=base & 0x00FF;
					DrawBuff[idx++]=getBlock_ret;
				}
			}
		}
	}
	idx=0;
	waitvblank();
	for(i=0;i<4;i++)
	{
		*(char*)(0x2006)=DrawBuff[idx++];
		*(char*)(0x2006)=DrawBuff[idx++];
		*(char*)(0x2007)=DrawBuff[idx++];
	}
	*(char*)(0x2005) = 0;
	*(char*)(0x2005) = 0;

	//clear line
	for(j=19;j>=0;j--)
	{
		char line=1;
		for(i=0;i<10;i++)
		{
			if(getBoard(i,j)==0)
			{
				line=0;
				break;
			}
		}
		if(line==1)
		{
			int k,l;
			for(k=0;k<10;k++)
			{
				if(j-1>=0)
				{
					setBoard(k,j-1,data1[getBoard(k,j-1)+0xE0]);
				}
				if(j+1<20)
				{
					setBoard(k,j+1,data1[getBoard(k,j+1)+0xF0]);
				}
				setBoard(k,j,0);
			}
			
			if(j-1>=0)
			{
				int base = 0x2020;
				base+=(19-(j-1)+2)<<5;
				base+=(0+2);
				DrawBuff[0]=base>>8;
				DrawBuff[1]=base&0x00FF;
				for(l=0;l<10;l++)
				{
					DrawBuff[2+l]=getBoard(l,j-1);
				}
				waitvblank();
				*(char*)(0x2006)=DrawBuff[0];
				*(char*)(0x2006)=DrawBuff[1];
				for(i=2;i<12;i++)
				{
					*(char*)(0x2007)=DrawBuff[i];
				}
				*(char*)(0x2005) = 0;
				*(char*)(0x2005) = 0;
			}
			for(k=j;k<19;k++)
			{
				for(l=0;l<10;l++)
				{
					setBoard(l,k,getBoard(l,k+1));
				}
				
				{
					int base = 0x2020;
					base+=(19-k+2)<<5;
					base+=(0+2);
					DrawBuff[0]=base>>8;
					DrawBuff[1]=base&0x00FF;
					for(l=0;l<10;l++)
					{
						DrawBuff[2+l]=getBoard(l,k);
					}
					waitvblank();
					*(char*)(0x2006)=DrawBuff[0];
					*(char*)(0x2006)=DrawBuff[1];
					for(i=2;i<12;i++)
					{
						*(char*)(0x2007)=DrawBuff[i];
					}
					*(char*)(0x2005) = 0;
					*(char*)(0x2005) = 0;
				}
			}
		}
		
	}
	
	//is gameover
	for(i=0;i<10;i++)
	{
		if(getBoard(i,18)!=0)
		{
			Clear();
			break;
		}
	}
	NextShape();
	//draw shape
	DrawShape();
	//TODO DRAW Next
}

int Any_Touch(){
	int i,j;
	if(PosX<0)
	{
		return 1;
	}
	if(getNowLeft()+PosX>10)
	{
		return 1;
	}
	for(i=0;i<4;i++)
	{
		for(j=0;j<4;j++)
		{
			int x=PosX+i;
			int y=PosY-j;
			getBlock_j = j;
			getNowBottom();
			if(PosY-getBlock_ret<-1)
			{
				return 1;
			}
			getBlock_i=i;
			getBlock_j=j;
			getNowBlock();
			if(x>=0&&y>=0&&x<10&&y<20&&getBlock_ret!=0&&getBoard(x,y)!=0)
			{
				return 1;
			}
		}
	}
	return 0;
}
void rotate(int n){
	int left;
	NowDirectionNo=(NowDirectionNo+4+n)&3;
	left = getNowLeft();
	if(left+PosX>10)
	{
		PosX=10-left;
	}
	if(Any_Touch())
	{
		NowDirectionNo=(NowDirectionNo+4-n)&3;
	}
	DrawShape();
}
void movelr(int n){
	PosX+=n;
	if(Any_Touch()==1)
	{
		PosX-=n;
	}
	DrawShape();
}
void down(){
	while(Touch()!=1)
	{
		PosY--;
	}
	TouchDo();
}

void slowdown(){
	if(Touch()==1)
	{
		TouchDo();
	}
	else
	{
		PosY--;
		DrawShape();
	}
}

void read_joystick_1(){
   char n=8;
   key1=0;
   *(char*)(0x4016)=01;
   *(char*)(0x4016)=00;
   while(n){
		key1=(key1<<1)|*(char*)(0x4016)&1;
		n--;
   }
}

void dummy()
{
	char i=5;
	while(i--)
	{
	}
asm ("lda	 _PosX");
asm ("ldx	 _PosX+1");
asm ("sta	 regsave");
asm ("stx	 regsave+1");
asm ("jsr	 incax1");
asm ("sta	 _PosX");
asm ("stx	 _PosX+1");
asm ("lda	 regsave");
asm ("ldx	 regsave+1");
}


void main()
{
	char i;

	dummy();
	
	//init pattern
	{
		*(char*)(0x2006)=0;
		*(char*)(0x2006)=0;
		for(i=0;i<255;i++)
		{
			*(char*)(0x2007)=img1[i];
		}
		*(char*)(0x2007)=img1[255];
		for(i=0;i<255;i++)
		{
			*(char*)(0x2007)=img2[i];
		}
		*(char*)(0x2007)=img2[255];
	}
	
	//clear SP
	{
		*(char*)(0x2003)=0; //i<<2
		for(i=0;i<64;i++)
		{
			*(char*)(0x2004)=0;
			*(char*)(0x2004)=0;
			*(char*)(0x2004)=0;
			*(char*)(0x2004)=0;
		}
	}
	
	//set background black
	{
		*(char*)(0x2006)=0x20;
		*(char*)(0x2006)=0x20;
		for(i=0;i<255;i++)
		{
			*(char*)(0x2007)=0x10;
		}
		*(char*)(0x2007)=0x10;
		for(i=0;i<255;i++)
		{
			*(char*)(0x2007)=0x10;
		}
		*(char*)(0x2007)=0x10;
		for(i=0;i<255;i++)
		{
			*(char*)(0x2007)=0x10;
		}
		*(char*)(0x2007)=0x10;
		for(i=0;i<128;i++)
		{
			*(char*)(0x2007)=0x10;
		}
	}

	//set color
	{
		*(char*)(0x2006)=0x3F;
		*(char*)(0x2006)=0x00;
		
		*(char*)(0x2007)=0x2C;
		*(char*)(0x2007)=0x30;
		*(char*)(0x2007)=0x00;
		*(char*)(0x2007)=0x3F;

		*(char*)(0x2006)=0x3F;
		*(char*)(0x2006)=0x11;
		*(char*)(0x2007)=0x30;
		*(char*)(0x2007)=0x22;
		*(char*)(0x2007)=0x3F;
	}
	
	//show init title
	{
		*(char*)(0x2006)=0x20;
		*(char*)(0x2006)=0xC5;

		*(char*)(0x2007)=0x11;
		*(char*)(0x2007)=0x12;
		*(char*)(0x2007)=0x13;
		*(char*)(0x2007)=0x14;
		*(char*)(0x2007)=0x10;
		*(char*)(0x2007)=0x15;
		*(char*)(0x2007)=0x10;
		*(char*)(0x2007)=0x16;
		*(char*)(0x2007)=0x17;
		*(char*)(0x2007)=0x18;
		
		*(char*)(0x2005) = 0;
		*(char*)(0x2005) = 0;
	}

	//init ppu
	{
		*(char*)(0x2000) = 0x80; //10 00 00 00
		*(char*)(0x2001) = 0x18; //00 01 10 00
		*(char*)(0x2005) = 0;
		*(char*)(0x2005) = 0;
	}
	//wait for key pressed (randomize)
	while(1)
	{
		getRnd7();
		read_joystick_1();
		if(key1!=0)break;
	}
	
	Clear();

	//clear 4*4 nextShape
	{
		waitvblank();
		*(char*)(0x2006)=0x20;
		*(char*)(0x2006)=0xAE;
		*(char*)(0x2007)=0;
		*(char*)(0x2007)=0;
		*(char*)(0x2007)=0;
		*(char*)(0x2007)=0;
		*(char*)(0x2005) = 0;
		*(char*)(0x2005) = 0;

		waitvblank();
		*(char*)(0x2006)=0x20;
		*(char*)(0x2006)=0xCE;
		*(char*)(0x2007)=0;
		*(char*)(0x2007)=0;
		*(char*)(0x2007)=0;
		*(char*)(0x2007)=0;
		
		*(char*)(0x2005) = 0;
		*(char*)(0x2005) = 0;

		waitvblank();
		*(char*)(0x2006)=0x20;
		*(char*)(0x2006)=0xEE;
		*(char*)(0x2007)=0;
		*(char*)(0x2007)=0;
		*(char*)(0x2007)=0;
		*(char*)(0x2007)=0;
		
		*(char*)(0x2005) = 0;
		*(char*)(0x2005) = 0;

		waitvblank();
		*(char*)(0x2006)=0x21;
		*(char*)(0x2006)=0x0E;
		*(char*)(0x2007)=0;
		*(char*)(0x2007)=0;
		*(char*)(0x2007)=0;
		*(char*)(0x2007)=0;

		*(char*)(0x2005) = 0;
		*(char*)(0x2005) = 0;
	}
	
	NextShape();
	NextShape();

	{
		char cnt = 0;
		char lastkey;
		
		while(1)
		{
			char key2;
			waitvblank();
			
			//one second count
			if(cnt++==50)
			{
				cnt=0;
				slowdown();
			}
			
			read_joystick_1();
			key2 = key1 ^ lastkey;
			key2 = key2 & key1;
			if(key2!=0)
			{
				//#define presskey(key,k) (key & (k))
				if(key1&0x01)movelr(1);//button_RIGHT
				if(key1&0x02)movelr(-1);//button_LEFT
				if(key2&0x04)down();//button_DOWN
				if(key1&0x08)slowdown();//button_UP
				if(key2&0x10);//button_START
				if(key2&0x20);//button_SELECT
				if(key2&0x40)rotate(-1);//button_B
				if(key2&0x80)rotate(1);//button_A
				
			}
			lastkey = key1;
		}
	}
}
